import { useState } from 'react';
import { useAccount } from 'wagmi';
import { usePoolChain } from '../hooks/usePoolChain';
import './PoolChainPage.css';

export function PoolChainPage() {
    const [selectedTier, setSelectedTier] = useState(null);
    const { address } = useAccount();
    const {
        currentPool,
        participants,
        claimable,
        buyTicket,
        claim,
        isLoading
    } = usePoolChain();

    // Definici√≥n de los 9 niveles con patr√≥n unificado
    const tiers = [
        {
            id: 'micro',
            name: 'Micro',
            icon: 'üíé',
            entry: 2,
            totalPool: 200,
            maxSlots: 100,
            groupA: { count: 10, prize: 5.82 },
            groupB: { count: 20, prize: 2.91 },
            groupC: { count: 30, prize: 1.29 },
            groupD: { count: 40, return: 0.97 },
            description: 'Ideal para comenzar con bajo riesgo - 100% ganan',
            badge: null
        },
        {
            id: 'mini',
            name: 'Mini',
            icon: 'üåü',
            entry: 5,
            totalPool: 500,
            maxSlots: 100,
            groupA: { count: 10, prize: 14.70 },
            groupB: { count: 20, prize: 7.35 },
            groupC: { count: 30, prize: 3.27 },
            groupD: { count: 40, return: 2.45 },
            description: 'Accesible y con buenos retornos - 100% ganan',
            badge: null
        },
        {
            id: 'basico',
            name: 'B√°sico',
            icon: '‚≠ê',
            entry: 10,
            totalPool: 1000,
            maxSlots: 100,
            groupA: { count: 10, prize: 29.40 },
            groupB: { count: 20, prize: 14.70 },
            groupC: { count: 30, prize: 6.53 },
            groupD: { count: 40, return: 4.90 },
            description: 'Perfecto para probar el sistema - 100% ganan',
            badge: null
        },
        {
            id: 'estandar',
            name: 'Est√°ndar',
            icon: 'üéØ',
            entry: 20,
            totalPool: 2000,
            maxSlots: 100,
            groupA: { count: 10, prize: 58.80 },
            groupB: { count: 20, prize: 29.40 },
            groupC: { count: 30, prize: 13.07 },
            groupD: { count: 40, return: 9.80 },
            description: 'El m√°s popular y equilibrado - 100% ganan',
            badge: '‚≠ê M√°s Popular'
        },
        {
            id: 'plus',
            name: 'Plus',
            icon: 'üî•',
            entry: 40,
            totalPool: 4000,
            maxSlots: 100,
            groupA: { count: 10, prize: 117.60 },
            groupB: { count: 20, prize: 58.80 },
            groupC: { count: 30, prize: 26.13 },
            groupD: { count: 40, return: 19.60 },
            description: 'Para usuarios con m√°s capital - 100% ganan',
            badge: null
        },
        {
            id: 'premium',
            name: 'Premium',
            icon: 'üí´',
            entry: 50,
            totalPool: 5000,
            maxSlots: 100,
            groupA: { count: 10, prize: 147 },
            groupB: { count: 20, prize: 73.50 },
            groupC: { count: 30, prize: 32.67 },
            groupD: { count: 40, return: 24.50 },
            description: 'Balance perfecto riesgo/retorno - 100% ganan',
            badge: null
        },
        {
            id: 'elite',
            name: 'Elite',
            icon: 'üëë',
            entry: 100,
            totalPool: 10000,
            maxSlots: 100,
            groupA: { count: 10, prize: 297 },
            groupB: { count: 20, prize: 148.50 },
            groupC: { count: 30, prize: 66 },
            groupD: { count: 40, return: 49.50 },
            description: 'Premios grandes, emoci√≥n m√°xima - 100% ganan',
            badge: null
        },
        {
            id: 'vip',
            name: 'VIP',
            icon: 'üíé',
            entry: 200,
            totalPool: 12000,
            maxSlots: 60,
            groupA: { count: 6, prize: 594 },
            groupB: { count: 12, prize: 297 },
            groupC: { count: 18, prize: 132 },
            groupD: { count: 24, return: 99 },
            description: 'Para jugadores serios - 100% ganan',
            badge: null
        },
        {
            id: 'diamante',
            name: 'Diamante',
            icon: 'üí†',
            entry: 500,
            totalPool: 30000,
            maxSlots: 60,
            groupA: { count: 6, prize: 1485 },
            groupB: { count: 12, prize: 742.50 },
            groupC: { count: 18, prize: 330 },
            groupD: { count: 24, return: 247.50 },
            description: 'Modelo exclusivo 60 participantes - 100% ganan',
            badge: 'üî• Premium'
        }
    ];

    // Si hay un tier seleccionado, mostrar dashboard
    if (selectedTier) {
        return (
            <TierDashboard
                tier={selectedTier}
                onBack={() => setSelectedTier(null)}
                address={address}
            />
        );
    }

    // Si no hay tier seleccionado, mostrar grid de selecci√≥n
    return (
        <div className="poolchain-page">
            <div className="poolchain-hero">
                <h1>PoolChain Sorteos</h1>
                <p className="hero-subtitle">
                    Elige el sorteo que mejor se adapte a tu perfil
                </p>
                <a href="/poolchain-info" className="info-link-hero">
                    üìö ¬øC√≥mo funciona el sistema? Aprende m√°s aqu√≠ ‚Üí
                </a>
            </div>

            <div className="poolchain-container">
                <div className="tiers-grid">
                    {tiers.map((tier) => (
                        <TierCard
                            key={tier.id}
                            tier={tier}
                            onSelect={() => setSelectedTier(tier)}
                        />
                    ))}
                </div>
            </div>
        </div>
    );
}

function TierCard({ tier, onSelect }) {
    return (
        <div className={`tier-card ${tier.badge ? 'tier-card-featured' : ''}`}>
            {tier.badge && <div className="tier-badge">{tier.badge}</div>}

            <div className="tier-icon">{tier.icon}</div>
            <h3 className="tier-name">{tier.name}</h3>

            <div className="tier-entry">
                <span className="entry-label">Entrada</span>
                <span className="entry-amount">{tier.entry} USDT</span>
            </div>

            <p className="tier-description">{tier.description}</p>

            <div className="tier-features">
                <div className="feature">
                    <span className="check">‚úì</span>
                    <span>Grupo A: {tier.groupA.count} ganan {tier.groupA.prize} USDT c/u</span>
                </div>
                <div className="feature">
                    <span className="check">‚úì</span>
                    <span>Grupo B: {tier.groupB.count} ganan {tier.groupB.prize} USDT c/u</span>
                </div>
                <div className="feature">
                    <span className="check">‚úì</span>
                    <span>Grupo C: {tier.groupC.count} ganan {tier.groupC.prize} USDT c/u</span>
                </div>
                <div className="feature">
                    <span className="check">‚úì</span>
                    <span>Grupo D: {tier.groupD.count} recuperan {tier.groupD.return} USDT c/u</span>
                </div>
                <div className="feature">
                    <span className="check">‚úì</span>
                    <span>Gas del sistema: {tier.entry === 2 ? '3%' : tier.entry <= 50 ? '2%' : '1%'}</span>
                </div>
            </div>

            <button onClick={onSelect} className="tier-select-btn">
                Participar en {tier.name} ‚Üí
            </button>
        </div>
    );
}

function TierDashboard({ tier, onBack, address }) {
    const {
        usdtBalance,
        participantCount,
        currentPool,
        poolFilled,
        winnersSelected,
        hasParticipated,
        userTicketCount,
        claimableAmount,
        isApproved,
        groupAWinners,
        groupBWinners,
        groupCWinners,
        groupDWinners,
        isInGroupA,
        isInGroupB,
        isInGroupC,
        isInGroupD,
        approveUSDT,
        buyTicket,
        executeDraw,
        claimPrize,
        isLoading,
        currentRound
    } = usePoolChain();

    const [showSuccess, setShowSuccess] = useState(false);
    const [successMessage, setSuccessMessage] = useState('');
    const [showError, setShowError] = useState(false);
    const [errorMessage, setErrorMessage] = useState('');

    const formatAddress = (addr) => {
        if (!addr) return 'No conectada';
        return `${addr.slice(0, 6)}...${addr.slice(-4)}`;
    };

    const handleApprove = async () => {
        try {
            await approveUSDT('1000');
            setSuccessMessage('‚úÖ USDT aprobado exitosamente');
            setShowSuccess(true);
            setTimeout(() => setShowSuccess(false), 3000);
        } catch (error) {
            setErrorMessage('‚ùå Error al aprobar USDT: ' + error.message);
            setShowError(true);
            setTimeout(() => setShowError(false), 5000);
        }
    };

    const handleBuyTicket = async () => {
        try {
            await buyTicket(1); // Comprar 1 ticket por defecto
            setSuccessMessage('‚úÖ Ticket comprado exitosamente');
            setShowSuccess(true);
            setTimeout(() => setShowSuccess(false), 3000);
        } catch (error) {
            setErrorMessage('‚ùå Error al comprar ticket: ' + error.message);
            setShowError(true);
            setTimeout(() => setShowError(false), 5000);
        }
    };

    const handleExecuteDraw = async () => {
        if (!window.confirm('¬øEjecutar sorteo? Esta acci√≥n seleccionar√° los ganadores.')) return;

        try {
            await executeDraw();
            setSuccessMessage('‚úÖ Sorteo ejecutado exitosamente');
            setShowSuccess(true);
            setTimeout(() => setShowSuccess(false), 3000);
        } catch (error) {
            setErrorMessage('‚ùå Error al ejecutar sorteo: ' + error.message);
            setShowError(true);
            setTimeout(() => setShowError(false), 5000);
        }
    };

    const handleClaim = async () => {
        try {
            await claimPrize();
            setSuccessMessage('‚úÖ Premio reclamado exitosamente');
            setShowSuccess(true);
            setTimeout(() => setShowSuccess(false), 3000);
        } catch (error) {
            setErrorMessage('‚ùå Error al reclamar premio: ' + error.message);
            setShowError(true);
            setTimeout(() => setShowError(false), 5000);
        }
    };

    const getUserGroup = () => {
        if (isInGroupA) return { name: 'A', prize: tier.groupA.prize, color: '#10b981' };
        if (isInGroupB) return { name: 'B', prize: tier.groupB.prize, color: '#3b82f6' };
        if (isInGroupC) return { name: 'C', prize: tier.groupC.prize, color: '#f59e0b' };
        if (isInGroupD) return { name: 'D', prize: tier.groupD.return, color: '#ef4444' };
        return null;
    };

    const userGroup = getUserGroup();

    return (
        <div className="tier-dashboard">
            {/* Notifications */}
            {showSuccess && (
                <div className="notification success-notification">
                    {successMessage}
                </div>
            )}
            {showError && (
                <div className="notification error-notification">
                    {errorMessage}
                </div>
            )}

            <div className="dashboard-container">
                {/* Header */}
                <div className="dashboard-header">
                    <h2 className="dashboard-title">
                        {tier.icon} {tier.name} #{currentRound?.toString().padStart(2, '0') || '01'}
                    </h2>
                    <div className="wallet-info">
                        <span className="wallet-label">Wallet:</span>
                        <span className="wallet-address">{formatAddress(address)}</span>
                    </div>
                </div>

                {/* Back Button */}
                <button onClick={onBack} className="back-button">
                    ‚Üê Volver a Selecci√≥n de Tiers
                </button>

                {/* Balance Card */}
                <div className="balance-card">
                    <div className="balance-header">
                        <h3>üí∞ Balance USDT</h3>
                    </div>
                    <div className="balance-amount">
                        {usdtBalance} USDT
                    </div>
                    <p className="balance-note">
                        {address ? 'Balance disponible para participar' : 'Conecta tu wallet para ver balance'}
                    </p>
                </div>

                {/* Tier Info */}
                <div className="tier-info-summary">
                    <h2>{tier.icon} {tier.name}</h2>
                    <p className="tier-summary-desc">{tier.description}</p>
                    <div className="tier-summary-stats">
                        <div className="stat-item">
                            <span className="stat-label">Entrada:</span>
                            <span className="stat-value">{tier.entry} USDT</span>
                        </div>
                        <div className="stat-item">
                            <span className="stat-label">Fondo Total:</span>
                            <span className="stat-value">{tier.totalPool} USDT</span>
                        </div>
                        <div className="stat-item">
                            <span className="stat-label">Cupos:</span>
                            <span className="stat-value">{tier.maxSlots}</span>
                        </div>
                    </div>
                </div>

                {/* Pool Status */}
                <div className="pool-status-card">
                    <h3>üìä Estado del Pool</h3>
                    <div className="pool-progress">
                        <div className="progress-bar">
                            <div
                                className="progress-fill"
                                style={{ width: `${(participantCount / tier.maxSlots) * 100}%` }}
                            ></div>
                        </div>
                        <div className="progress-text">
                            {participantCount} / {tier.maxSlots} participantes
                        </div>
                    </div>
                    <div className="pool-stats">
                        <div className="pool-stat">
                            <span>Pool Actual:</span>
                            <strong>{currentPool} USDT</strong>
                        </div>
                        <div className="pool-stat">
                            <span>Estado:</span>
                            <strong className={poolFilled ? 'status-filled' : 'status-open'}>
                                {poolFilled ? '‚úì Lleno' : '‚óã Abierto'}
                            </strong>
                        </div>
                    </div>
                </div>

                {/* User Status */}
                {address && (
                    <div className="user-status-card">
                        <h3>üë§ Tu Estado</h3>
                        <div className="status-grid">
                            <div className="status-item">
                                <span>Participaci√≥n:</span>
                                <strong className={hasParticipated ? 'status-yes' : 'status-no'}>
                                    {hasParticipated ? '‚úì Participando' : '‚óã No participando'}
                                </strong>
                            </div>
                            <div className="status-item">
                                <span>Aprobaci√≥n USDT:</span>
                                <strong className={isApproved ? 'status-yes' : 'status-no'}>
                                    {isApproved ? '‚úì Aprobado' : '‚óã Pendiente'}
                                </strong>
                            </div>
                        </div>
                    </div>
                )}

                {/* Actions */}
                <div className="actions-card">
                    <h3>‚ö° Acciones</h3>

                    {!address && (
                        <p className="action-note">Conecta tu wallet para participar</p>
                    )}

                    {address && !isApproved && (
                        <button
                            onClick={handleApprove}
                            className="action-btn approve-btn"
                            disabled={isLoading}
                        >
                            {isLoading ? '‚è≥ Aprobando...' : '1. Aprobar USDT'}
                        </button>
                    )}

                    {address && isApproved && !hasParticipated && !poolFilled && (
                        <button
                            onClick={handleBuyTicket}
                            className="action-btn buy-btn"
                            disabled={isLoading}
                        >
                            {isLoading ? '‚è≥ Comprando...' : `2. Comprar Ticket (${tier.entry} USDT)`}
                        </button>
                    )}

                    {hasParticipated && !winnersSelected && (
                        <div className="waiting-status">
                            ‚è≥ Esperando a que se llene el pool...
                        </div>
                    )}

                    {poolFilled && !winnersSelected && (
                        <button
                            onClick={handleExecuteDraw}
                            className="action-btn execute-btn"
                            disabled={isLoading}
                        >
                            {isLoading ? '‚è≥ Ejecutando...' : 'üé≤ Ejecutar Sorteo (Admin)'}
                        </button>
                    )}
                </div>

                {/* Winners Display */}
                {winnersSelected && (
                    <div className="winners-card">
                        <h3>üèÜ Ganadores del Sorteo</h3>

                        {userGroup && (
                            <div className="user-winner-banner" style={{ borderColor: userGroup.color }}>
                                <span className="winner-emoji">üéâ</span>
                                <div>
                                    <strong>¬°Felicidades! Est√°s en el Grupo {userGroup.name}</strong>
                                    <p>Premio: {userGroup.prize} USDT</p>
                                </div>
                            </div>
                        )}

                        <div className="winners-grid">
                            <div className="winner-group group-a">
                                <h4>Grupo A ({groupAWinners.length})</h4>
                                <p className="group-prize">{tier.groupA.prize} USDT c/u</p>
                                <div className="winner-count">{groupAWinners.length} ganadores</div>
                            </div>
                            <div className="winner-group group-b">
                                <h4>Grupo B ({groupBWinners.length})</h4>
                                <p className="group-prize">{tier.groupB.prize} USDT c/u</p>
                                <div className="winner-count">{groupBWinners.length} ganadores</div>
                            </div>
                            <div className="winner-group group-c">
                                <h4>Grupo C ({groupCWinners.length})</h4>
                                <p className="group-prize">{tier.groupC.prize} USDT c/u</p>
                                <div className="winner-count">{groupCWinners.length} ganadores</div>
                            </div>
                            <div className="winner-group group-d">
                                <h4>Grupo D ({groupDWinners.length})</h4>
                                <p className="group-prize">{tier.groupD.return} USDT c/u</p>
                                <div className="winner-count">{groupDWinners.length} ganadores</div>
                            </div>
                        </div>
                    </div>
                )}

                {/* Claim Prize */}
                {winnersSelected && parseFloat(claimableAmount) > 0 && (
                    <div className="claim-card">
                        <h3>üíé Reclamar Premio</h3>
                        <div className="claimable-amount">
                            {claimableAmount} USDT
                        </div>
                        <button
                            onClick={handleClaim}
                            className="action-btn claim-btn"
                            disabled={isLoading}
                        >
                            {isLoading ? '‚è≥ Reclamando...' : 'üí∞ Reclamar Premio'}
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
}
